# sudo chown -R 1001:1001 ./sql
# sudo chmod -R 755 ./sql
# dos2unix ./redis/10-initial.sh


services:
  primary-database:
    image: bitnami/postgresql:latest
    restart: always
    ports:
      - 7001:5432
    networks:
      - inner-link
    environment:
      POSTGRES_USER: database.imptel
      POSTGRES_PASSWORD: Imp7e1_db
      POSTGRES_DATABASE: database.imptel
      POSTGRES_REPLICATION_MODE: master
      POSTGRES_REPLICATION_USER: db_replicator
      POSTGRES_REPLICATION_PASSWORD: Imp7e1_db_replicator
    volumes:
      - database-data:/bitnami/postgresql
      - ./sql:/docker-entrypoint-initdb.d

  replica-database:
    image: bitnami/postgresql:latest
    restart: always
    ports:
      - 7002:5432
    networks:
      - inner-link
    environment:
      POSTGRES_USER: database.imptel
      POSTGRES_PASSWORD: Imp7e1_db
      POSTGRES_DATABASE: database.imptel
      POSTGRES_REPLICATION_MODE: slave
      POSTGRES_MASTER_HOST: primary-database
      POSTGRES_MASTER_PORT: 5432
      POSTGRES_REPLICATION_USER: db_replicator
      POSTGRES_REPLICATION_PASSWORD: Imp7e1_db_replicator
    depends_on:
      - primary-database
    volumes:
      - database-replica-data:/bitnami/postgresql

  
  session-database:
    image: redis:alpine3.19
    restart: always
    ports:
      - 7012:6379
    networks:
      - inner-link
    command: ["sh", "-c", "redis-server /etc/redis/redis.conf --save 20 1 --loglevel warning --daemonize yes && /docker-entrypoint-initdb.d/10-initial.sh && tail -f /dev/null"]
    volumes:
      - session-data:/data
      - ./redis:/docker-entrypoint-initdb.d
      - ./redis/redis.conf:/etc/redis/redis.conf


  # account-service:
  #   image: account-service:1.0
  #   restart: always
  #   networks:
  #     - inner-link
  #   environment:
  #     DB_USER: database.imptel
  #     DB_PASSWORD: Imp7e1_db
  #     DB_HOST: primary-database
  #     DB_PORT: 5432
  #     DB_NAME: database.imptel
  #     # --
  #     DB_READONLY_USER: database.imptel
  #     DB_READONLY_PASSWORD: Imp7e1_db
  #     DB_READONLY_HOST: replica-database
  #     DB_READONLY_PORT: 5432
  #     DB_READONLY_NAME: database.imptel
  #     # --
  #     REDIS_HOST: session-database
  #     REDIS_PORT: 6379
  #     REDIS_PASSWORD: Imp7e1_db_session
  #   depends_on:
  #     - session-database
  #     - primary-database
  #   # deploy:
  #   #   replicas: 2


  # registry-service:
  #   image: registry-service:1.0
  #   restart: always
  #   networks:
  #     - inner-link
  #   environment:
  #     DB_USER: database.imptel
  #     DB_PASSWORD: Imp7e1_db
  #     DB_HOST: primary-database
  #     DB_PORT: 5432
  #     DB_NAME: database.imptel
  #     # --
  #     DB_READONLY_USER: database.imptel
  #     DB_READONLY_PASSWORD: Imp7e1_db
  #     DB_READONLY_HOST: replica-database
  #     DB_READONLY_PORT: 5432
  #     DB_READONLY_NAME: database.imptel
  #     # --
  #     REDIS_HOST: session-database
  #     REDIS_PORT: 6379
  #     REDIS_PASSWORD: Imp7e1_db_session
  #   depends_on:
  #     - session-database
  #     - primary-database
  #   # deploy:
  #   #   replicas: 2
      
  
  # auxiliar-service:
  #   image: auxiliar-service:1.0
  #   restart: always
  #   networks:
  #     - inner-link
  #   environment:
  #     DB_USER: database.imptel
  #     DB_PASSWORD: Imp7e1_db
  #     DB_HOST: primary-database
  #     DB_PORT: 5432
  #     DB_NAME: database.imptel
  #     # --
  #     DB_READONLY_USER: database.imptel
  #     DB_READONLY_PASSWORD: Imp7e1_db
  #     DB_READONLY_HOST: replica-database
  #     DB_READONLY_PORT: 5432
  #     DB_READONLY_NAME: database.imptel
  #     # --
  #     REDIS_HOST: session-database
  #     REDIS_PORT: 6379
  #     REDIS_PASSWORD: Imp7e1_db_session
  #   depends_on:
  #     - session-database
  #     - primary-database
  #   # deploy:
  #   #   replicas: 2
    

  # app-service:
  #   image: app-service:1.0
  #   restart: always
  #   networks:
  #     - inner-link
  #   depends_on:
  #     - account-service
  #     - registry-service
  #     - auxiliar-service
  #   # deploy:
  #   #   replicas: 2


  # nginx-service:
  #   image: nginx-service:1.0
  #   ports:
  #     - 80:80
  #   networks:
  #     - inner-link
  #   depends_on:
  #     - account-service
  #     - registry-service
  #     - auxiliar-service
  #     - app-service
    
    

volumes:
  database-data:
    name: database-data
  database-replica-data:
    name: database-replica-data
  session-data:
    name: session-data


networks:
  inner-link:
    name: inner-link